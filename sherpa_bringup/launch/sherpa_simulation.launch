<?xml version="1.0"?>
<!-- 
  Haupt-Launch-Datei für die SHERPA-Simulation
  Diese Datei startet die gesamte Simulationsumgebung einschließlich:
  - Gazebo mit Sherpa-Roboter und LiDAR
  - Tastatur-Teleop-Steuerung
  - Optional: OctoMap-Visualisierung für 3D-Umgebungskartierung
-->
<launch>
  <!-- Allgemeine Argumente -->
  <arg name="debug" default="false" doc="Gazebo im Debug-Modus starten"/>
  <arg name="gui" default="true" doc="Gazebo GUI anzeigen"/>
  <arg name="use_rviz" default="true" doc="RViz starten für die Roboter-Visualisierung"/>
  <arg name="enable_octomap" default="false" doc="OctoMap-Visualisierung aktivieren"/>
  <!-- Deaktiviere den zweiten LiDAR, um nur den RPLiDAR zu verwenden -->
  <arg name="laser_enabled" default="false" doc="Zweiten LiDAR (Velodyne) aktivieren/deaktivieren"/>
  <!-- RPLiDAR Parameter -->
  <arg name="rplidar_enabled" default="true" doc="RPLiDAR in der Simulation aktivieren"/>
  
  <!-- Roboter-Startposition -->
  <arg name="x" default="0.0"/>
  <arg name="y" default="0.0"/>
  <arg name="z" default="0.4"/>
  <arg name="roll" default="0.0"/>
  <arg name="pitch" default="0.0"/>
  <arg name="yaw" default="0.0"/>
  
  <!-- OctoMap-Parameter -->
  <arg name="octomap_resolution" default="0.1" doc="Auflösung der OctoMap in Metern"/>
  <arg name="sensor_range" default="5.0" doc="Maximale Sensorreichweite für OctoMap"/>
  
  <!-- 1. Starte Gazebo mit dem Sherpa-Roboter -->
  <include file="$(find sherpa_gazebo)/launch/sherpa_gazebo.launch">
    <arg name="debug" value="$(arg debug)"/>
    <arg name="run_gui" value="$(arg gui)"/>
    <arg name="x" value="$(arg x)"/>
    <arg name="y" value="$(arg y)"/>
    <arg name="z" value="$(arg z)"/>
    <arg name="roll" value="$(arg roll)"/>
    <arg name="pitch" value="$(arg pitch)"/>
    <arg name="yaw" value="$(arg yaw)"/>
    <arg name="laser_enabled" value="$(arg laser_enabled)"/>
    <arg name="start_teleop" value="false"/>
  </include>
  
  <!-- Starte RPLiDAR-Integration für die Simulation -->
  <group if="$(arg rplidar_enabled)">
    <include file="$(find rplidar_ros)/launch/sherpa_rplidar_sim.launch" />
  </group>

  <!-- 2. Starte Tastatur-Teleop-Steuerung -->
  <include file="$(find sherpa_teleop)/launch/sherpa_teleop.launch" />

  <!-- 3. Starte RViz für die Roboter-Visualisierung (wenn aktiviert) -->
  <group if="$(arg use_rviz)">
    <!-- Standard Visualisierung (sherpa oder unsere neue Konfiguration) -->
    <group unless="$(arg enable_octomap)">
      <!-- Verwende unsere neue angepasste RPLiDAR-Visualisierung -->
      <node pkg="rviz" type="rviz" name="rviz" 
            args="-d $(find sherpa_bringup)/rviz/sherpa_simulation.rviz"/>
    </group>
  </group>

  <!-- 4. Starte OctoMap-Visualisierung (wenn aktiviert) -->
  <group if="$(arg enable_octomap)">
    <!-- Start OctoMap Server konfiguriert für LaserScan-Eingabe -->
    <node pkg="octomap_server" type="octomap_server_node" name="octomap_server" output="screen">
      <param name="resolution" value="$(arg octomap_resolution)"/>
      <param name="frame_id" value="map"/>
      <param name="sensor_model/max_range" value="$(arg sensor_range)"/>
      
      <!-- LaserScan-spezifische Konfiguration -->
      <param name="height_map" value="false"/>
      <param name="colored_map" value="false"/>
      <param name="filter_ground" value="false"/>
      <param name="ground_filter/distance" value="0.04"/>
      <param name="ground_filter/angle" value="0.15"/>
      <param name="ground_filter/plane_distance" value="0.07"/>
      
      <!-- Eingabe: LaserScan-Daten vom LiDAR -->
      <remap from="scan" to="/scan"/>
      
      <!-- Basis-Frame für die Transformation -->
      <param name="base_frame_id" value="base_link"/>
    </node>
    
    <!-- Starte RViz mit OctoMap-Konfiguration -->
    <node pkg="rviz" type="rviz" name="rviz" args="-d $(find sherpa_description)/rviz/sherpa_octomap.rviz"/>
  </group>
</launch>